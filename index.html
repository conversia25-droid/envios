<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Início | Paiva Dashboard</title>

  <link rel="stylesheet" href="theme.css"/>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main class="main-content">
    <header class="page-header">
      <h1>Painel Geral</h1>
      <p>Resumo do sistema e indicadores em tempo real.</p>
    </header>

    <!-- ===================== RESUMO ===================== -->
    <section class="summary-grid">
      <div class="summary-item">
        <div class="label">Total de Disparos</div>
        <div class="value" id="total-envios">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Disparos Hoje</div>
        <div class="value" id="envios-hoje">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Instâncias Ativas</div>
        <div class="value" id="instancias-ativas">0</div>
      </div>
    </section>

    <!-- ===================== GRÁFICO DE ENVIOS ===================== -->
    <section class="cards-grid">
      <div class="card">
        <h2>Gráfico de Disparos por Hora</h2>
        <div style="height:340px;">
          <canvas id="chartEnvios"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>Disparos por Instância</h2>
        <div style="height:340px;">
          <canvas id="chartInstancias"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- ========== SCRIPTS ========== -->
  <script src="auth.js"></script>
  <script src="layout.js"></script>

  <script>
  // ============================================
  // SUPABASE via AUTH + tabela dinâmica por tenant
  // ============================================
  const { url: SB_URL } = AUTH.getSupabaseInfo();
  const SB_HEADERS = AUTH.getSupabaseHeaders();
  const TABLE = AUTH.getDisparosTable(); // disparos_log | disparos_log_local | disparos_log_vps1

  async function fetchDisparos(limit = 2000) {
    const url = `${SB_URL}/rest/v1/${TABLE}?select=instancia,created_at,status&order=created_at.asc&limit=${limit}`;
    const res = await fetch(url, { headers: SB_HEADERS });
    return res.ok ? res.json() : [];
  }

  // ============================================
  // ATUALIZA OS INDICADORES
  // ============================================
  async function atualizarIndicadores() {
    const data = await fetchDisparos();
    const total = data.length;

    const hoje = new Date().toISOString().split('T')[0];
    const enviadosHoje = data.filter(d => (d.created_at || '').startsWith(hoje)).length;

    const instancias = new Set(data.map(d => d.instancia));
    document.getElementById('total-envios').textContent = total.toLocaleString('pt-BR');
    document.getElementById('envios-hoje').textContent = enviadosHoje.toLocaleString('pt-BR');
    document.getElementById('instancias-ativas').textContent = instancias.size;
  }

  // ============================================
  // GRÁFICO DE ENVIOS POR HORA / POR INSTÂNCIA
  // ============================================
  let chartEnvios, chartInstancias;

  async function atualizarGraficos() {
    const data = await fetchDisparos();
    if (!data.length) return;

    // --- Agrupa por hora ---
    const porHora = {};
    data.forEach(d => {
      const hora = new Date(d.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit' });
      porHora[hora] = (porHora[hora] || 0) + 1;
    });

    // --- Agrupa por instância ---
    const porInstancia = {};
    data.forEach(d => {
      const key = d.instancia || '—';
      porInstancia[key] = (porInstancia[key] || 0) + 1;
    });

    // --- Gráfico 1 (linha) ---
    const ctx1 = document.getElementById('chartEnvios').getContext('2d');
    if (!chartEnvios) {
      chartEnvios = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: Object.keys(porHora),
          datasets: [{
            label: 'Mensagens Enviadas',
            data: Object.values(porHora),
            borderWidth: 2,
            fill: true
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    } else {
      chartEnvios.data.labels = Object.keys(porHora);
      chartEnvios.data.datasets[0].data = Object.values(porHora);
      chartEnvios.update();
    }

    // --- Gráfico 2 (barras) ---
    const ctx2 = document.getElementById('chartInstancias').getContext('2d');
    if (!chartInstancias) {
      chartInstancias = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: Object.keys(porInstancia),
          datasets: [{
            label: 'Envios por Instância',
            data: Object.values(porInstancia),
            borderWidth: 1
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    } else {
      chartInstancias.data.labels = Object.keys(porInstancia);
      chartInstancias.data.datasets[0].data = Object.values(porInstancia);
      chartInstancias.update();
    }
  }

  // Atualiza tudo a cada 10 segundos
  setInterval(() => {
    atualizarIndicadores();
    atualizarGraficos();
  }, 10000);

  atualizarIndicadores();
  atualizarGraficos();
  </script>
</body>
</html>
