<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Relatórios — Admin (paginado)</title>

  <link rel="stylesheet" href="theme.css"/>
  <link rel="stylesheet" href="style.css"/>

  <style>
    body {
      background: var(--bg,#f9fafb);
      color: var(--fg,#111);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .muted { color:#6b7280; font-size:.9rem; }

    .page-header h1 {
      margin:0 0 4px;
      font-size:1.15rem;
      font-weight:600;
    }
    .page-header p { margin:0; }

    .toolbar {
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .select {
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:.9rem;
      background:#fff;
    }
    .btn {
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      background:#fff;
      font-size:.9rem;
      cursor:pointer;
      white-space:nowrap;
      flex-shrink:0;
    }
    .btn:disabled { opacity:.4; cursor:not-allowed; }
    .btn-primary {
      background:#0a8f83;
      border:none;
      color:#fff;
      font-weight:600;
    }

    .filters-card {
      background:#fff;
      border-radius:12px;
      box-shadow:0 1px 4px rgb(0 0 0 / .06);
      padding:12px;
      margin-bottom:16px;
    }

    .relatorios-wrapper {
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:flex-start;
    }

    .relatorio-card {
      flex:1 1 320px;
      min-width:300px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 1px 4px rgb(0 0 0 / .06);
      padding:12px;

      /* garante consistência de layout em todas as colunas */
      display:flex;
      flex-direction:column;
      max-width:100%;
    }

    /* header do card (título + hint) */
    .relatorio-card h3 {
      margin:0 0 8px;
      font-size:1rem;
      font-weight:600;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      line-height:1.2;
      flex-wrap:nowrap;
      white-space:nowrap;
    }

    /* nome do card (ex: VPS1) fica do lado esquerdo e pode cortar com reticências */
    .relatorio-card h3 span:first-child {
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:60%;
      display:inline-block;
    }

    /* subtítulo cinza (ex: disparos_log_vps1) fica compacto à direita */
    .relatorio-card h3 .card-hint {
      font-size:.7rem;
      color:#6b7280;
      font-weight:400;
      white-space:nowrap;
      flex-shrink:0;
    }

    /* barra com paginação/botões */
    .controls {
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      row-gap:8px;
      column-gap:8px;
      margin-bottom:8px;
    }

    .controls .page-indicator {
      font-weight:600;
      font-size:.9rem;
      white-space:nowrap;
    }

    .table-scroll {
      max-height:520px;
      overflow:auto;
      border-top:1px solid #eee;
      border-radius:8px;
      background:#fff;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:.85rem;
      min-width:100%;
      table-layout:fixed; /* garante colunas com larguras estáveis */
    }

    thead th {
      text-align:left;
      padding:8px;
      background:#fbfbfb;
      position:sticky;
      top:0;
      z-index:1;
      font-weight:600;
      border-bottom:1px solid #e5e7eb;
      white-space:nowrap;
    }

    tbody td {
      padding:8px;
      border-top:1px solid #f3f3f3;
      vertical-align:top;
      line-height:1.3;
      word-break:break-word;
    }

    /* fixa largura das colunas pra não quebrar layout no 3º card */
    .table-scroll th:nth-child(1),
    .table-scroll td:nth-child(1) {
      width:32%;
      word-break:break-word;
    }
    .table-scroll th:nth-child(2),
    .table-scroll td:nth-child(2) {
      width:14%;
      text-align:left;
      word-break:break-word;
    }
    .table-scroll th:nth-child(3),
    .table-scroll td:nth-child(3) {
      width:34%;
      word-break:break-all; /* número pode ser grande */
    }
    .table-scroll th:nth-child(4),
    .table-scroll td:nth-child(4) {
      width:20%;
      text-align:center;
    }

    .badge-ok {
      background:#10b981;
      color:#fff;
      padding:4px 8px;
      border-radius:999px;
      font-weight:600;
      font-size:.75rem;
      display:inline-block;
      line-height:1.2;
      white-space:nowrap;
    }
    .badge-err {
      background:#ef4444;
      color:#fff;
      padding:4px 8px;
      border-radius:999px;
      font-weight:600;
      font-size:.75rem;
      display:inline-block;
      line-height:1.2;
      white-space:nowrap;
    }
  </style>
</head>
<body>
  <main class="main-content" style="padding:16px; max-width:1600px; margin:0 auto;">
    <header class="page-header" style="margin-bottom:12px;">
      <h1>Relatórios — Admin (paginado)</h1>
      <p class="muted">
        Visão unificada (Produção / Local / VPS1). Listas lado a lado. 500 registros por página. Status “enviado” em verde.
      </p>
    </header>

    <!-- proteção admin -->
    <script src="auth.js"></script>
    <script>
      const __tenant = AUTH.getTenant();
      if (!__tenant || __tenant.id !== "admin") {
        alert("Acesso restrito ao administrador.");
        location.href = "login.html";
      }
    </script>

    <section id="filters" class="filters-card">
      <div class="toolbar">
        <label class="muted">Data:</label>
        <input type="date" id="date-filter" class="select" value="" />

        <label class="muted">Instância:</label>
        <select id="instance-filter" class="select">
          <option value="">Todas</option>
        </select>

        <button id="refresh-btn" class="btn">Atualizar</button>

        <span class="muted" id="leads-hint">Carregando…</span>
      </div>
    </section>

    <section class="relatorios-wrapper" id="relatorios-wrapper">
      <!-- cards gerados dinamicamente -->
    </section>
  </main>

  <script src="layout.js"></script>
  <script>
  (function(){

    // 1. Configuração Supabase (puxado do auth.js que você já tem)
    const supa = AUTH.getSupabaseInfo();
    const SB_URL = supa.url;
    const BASE_HEADERS = {
      "Content-Type": "application/json",
      "Accept": "application/json",
      "apikey": supa.key,
      "Authorization": "Bearer " + supa.key,
      "Prefer": "return=representation,count=exact",
      "Range-Unit": "items"
    };

    // 2. Tabelas monitoradas
    const TABLES = [
      { key: 'disparos_log_vps1',     name: 'VPS1    ' },
      { key: 'disparos_log_local',    name: 'Local'    },
      { key: 'disparos_log',          name: 'Produção' }
    ];

    const LEAD_FIELD = 'numero';
    const PAGE_SIZE = 500;

    // 3. Estado de paginação por tabela
    const state = {};
    TABLES.forEach(t => {
      state[t.key] = {
        page: 0,
        rows: [],
        hasMore: true,
        loading: false
      };
    });

    // ===== Helpers =====

    // Formata data/hora do banco pro padrão BR
    function fmtDate(dtStr) {
      if (!dtStr) return '—';
      const d = new Date(dtStr);
      if (isNaN(d)) return dtStr;
      return d.toLocaleString('pt-BR', {
        dateStyle: 'short',
        timeStyle: 'short'
      });
    }

    // Cria badge verde/vermelha pro status
    function badgeStatus(st) {
      const ok = /ok|enviado/i.test(st || '');
      return ok
        ? '<span class="badge-ok">' + (st || 'OK') + '</span>'
        : '<span class="badge-err">' + (st || 'Erro') + '</span>';
    }

    // Monta o HTML interno de cada card (cada tabela)
    function buildCardHtml(tableKey, title) {
      return `
        <div class="relatorio-card" id="card-${tableKey}">
          <h3>
            <span>${title}</span>
            <span class="card-hint">${tableKey}</span>
          </h3>

          <div class="controls">
            <button class="btn" data-action="prev" data-table="${tableKey}">Anterior</button>
            <button class="btn" data-action="next" data-table="${tableKey}">Próxima</button>

            <div class="page-indicator" id="page-${tableKey}">Página 1</div>

            <div style="flex:1"></div>

            <button class="btn btn-primary" data-action="export" data-table="${tableKey}">
              Exportar CSV
            </button>
          </div>

          <div class="table-scroll">
            <table aria-label="${title}">
              <thead>
                <tr>
                  <th>Data/Hora</th>
                  <th>Instância</th>
                  <th>Número</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tbody-${tableKey}">
                <tr><td colspan="4" class="muted">Carregando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // Renderiza os 3 cards só uma vez
    function renderCardsOnce() {
      const wrap = document.getElementById('relatorios-wrapper');
      if (!wrap) return;
      if (wrap.dataset.built === "1") return;

      wrap.innerHTML = TABLES.map(t => buildCardHtml(t.key, t.name)).join('');
      wrap.dataset.built = "1";

      // adiciona listeners dos botões
      wrap.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', onCardButton);
      });
    }

    // ===== Filtro de data como intervalo (gte / lt) =====
    // Ex.: se você escolhe 2025-10-28, buscamos:
    // created_at >= 2025-10-28T00:00:00
    // created_at <  2025-10-29T00:00:00
    function buildDateFilterParts(dateStr) {
      if (!dateStr) return {gte: null, lt: null};

      const [y, m, d] = dateStr.split("-").map(Number);

      // início do dia selecionado
      const start = `${dateStr}T00:00:00`;

      // dia seguinte (UTC) pra fazer o "lt"
      const base = new Date(Date.UTC(y, m-1, d, 0, 0, 0));
      const next = new Date(base.getTime() + 24*60*60*1000);

      const yyyy = next.getUTCFullYear();
      const mm   = String(next.getUTCMonth()+1).padStart(2,"0");
      const dd   = String(next.getUTCDate()).padStart(2,"0");
      const endExclusive = `${yyyy}-${mm}-${dd}T00:00:00`;

      return { gte: start, lt: endExclusive };
    }

    // ===== Busca paginada no Supabase =====
    async function fetchPage(tableKey, page, limit = PAGE_SIZE) {
      const start = page * limit;
      const end   = start + limit - 1;

      const dateFilter = document.getElementById('date-filter').value || "";
      const instanceFilter = document.getElementById('instance-filter').value || "";

      let url = SB_URL + '/rest/v1/' + tableKey +
        '?select=instancia,created_at,status,' + LEAD_FIELD +
        '&order=created_at.desc';

      // aplica intervalo de data se houver filtro
      if (dateFilter.trim() !== "") {
        const range = buildDateFilterParts(dateFilter.trim());
        if (range.gte) {
          url += '&created_at=gte.' + encodeURIComponent(range.gte);
        }
        if (range.lt) {
          url += '&created_at=lt.' + encodeURIComponent(range.lt);
        }
      }

      // aplica filtro de instância se houver
      if (instanceFilter.trim() !== "") {
        url += '&instancia=eq.' + encodeURIComponent(instanceFilter.trim());
      }

      // paginação via header Range
      const headers = {
        ...BASE_HEADERS,
        "Range": start + "-" + end
      };

      try {
        const res = await fetch(url, { headers });
        if (!res.ok) {
          console.error('fetchPage erro', tableKey, res.status, await res.text());
          return [];
        }
        const data = await res.json();
        return data;
      } catch (err) {
        console.error('fetchPage catch', tableKey, err);
        return [];
      }
    }

    // Carrega página atual (ou vai pra próxima/anterior)
    async function loadPageFor(tableKey, direction = 0) {
      const s = state[tableKey];
      if (s.loading) return;
      s.loading = true;

      if (direction === 1) {
        s.page++;
      } else if (direction === -1) {
        s.page = Math.max(0, s.page - 1);
      }

      const rows = await fetchPage(tableKey, s.page);
      s.rows = rows;
      s.hasMore = (rows.length === PAGE_SIZE);
      s.loading = false;

      updateCardUI(tableKey);
    }

    // Atualiza o HTML da tabela, paginação e botões
    function updateCardUI(tableKey) {
      const s = state[tableKey];
      const tbody = document.getElementById('tbody-' + tableKey);
      const pageEl = document.getElementById('page-' + tableKey);
      const card = document.getElementById('card-' + tableKey);

      if (!tbody || !pageEl || !card) return;

      if (!s.rows || !s.rows.length) {
        tbody.innerHTML = `
          <tr><td colspan="4" class="muted">Nenhum registro nesta página.</td></tr>
        `;
      } else {
        tbody.innerHTML = s.rows.map(r => `
          <tr>
            <td>${fmtDate(r.created_at)}</td>
            <td>${r.instancia || '—'}</td>
            <td>${r[LEAD_FIELD] || '—'}</td>
            <td>${badgeStatus(r.status)}</td>
          </tr>
        `).join('');
      }

      pageEl.textContent = 'Página ' + (s.page + 1);

      const prevBtn = card.querySelector('button[data-action="prev"]');
      const nextBtn = card.querySelector('button[data-action="next"]');
      if (prevBtn) prevBtn.disabled = (s.page === 0);
      if (nextBtn) nextBtn.disabled = !s.hasMore;
    }

    // Exporta CSV só da página atual
    function exportCsv(tableKey) {
      const s = state[tableKey];
      const header = ['Data/Hora','Instância','Número','Status'];
      const lines = (s.rows || []).map(r => {
        const cols = [
          fmtDate(r.created_at),
          r.instancia || '',
          r[LEAD_FIELD] || '',
          r.status || ''
        ];
        return cols.map(v => {
          const text = (v || '').toString();
          return /[",\n;]/.test(text)
            ? '"' + text.replace(/"/g, '""') + '"'
            : text;
        }).join(',');
      });

      const csv = [header.join(','), ...lines].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url;
      a.download = 'leads_' + tableKey + '_page' + (state[tableKey].page+1) + '.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Monta o dropdown de instâncias disponíveis
    async function populateInstances() {
      const headers = {
        ...BASE_HEADERS,
        "Range": "0-199"
      };

      let allRows = [];
      for (const t of TABLES) {
        const url = SB_URL + '/rest/v1/' + t.key +
          '?select=instancia&order=created_at.desc';
        try {
          const res = await fetch(url, { headers });
          if (res.ok) {
            const data = await res.json();
            allRows = allRows.concat(data);
          }
        } catch(e) {
          console.error("populateInstances catch", e);
        }
      }

      const instSet = new Set();
      allRows.forEach(r => { if (r.instancia) instSet.add(r.instancia); });

      const combo = document.getElementById('instance-filter');
      const currentVal = combo.value;
      combo.innerHTML = '<option value="">Todas</option>';
      Array.from(instSet).sort().forEach(inst => {
        const opt = document.createElement('option');
        opt.value = inst;
        opt.textContent = inst;
        combo.appendChild(opt);
      });
      if ([...instSet].includes(currentVal)) combo.value = currentVal;
    }

    // Atualiza tudo: dados tabela + instâncias + timestamp "Atualizado: ..."
    async function refreshAll(resetPage=true) {
      renderCardsOnce();

      if (resetPage) {
        TABLES.forEach(t => { state[t.key].page = 0; });
      }

      // recarrega cada tabela respeitando filtros atuais
      for (const t of TABLES) {
        await loadPageFor(t.key, 0);
      }

      // atualiza o select de instância
      await populateInstances();

      document.getElementById('leads-hint').textContent =
        'Atualizado: ' + new Date().toLocaleString('pt-BR');
    }

    // Listener dos botões dentro de cada card
    function onCardButton(e) {
      const btn = e.currentTarget;
      const table = btn.getAttribute('data-table');
      const action = btn.getAttribute('data-action');
      if (action === 'prev') {
        loadPageFor(table, -1);
      } else if (action === 'next') {
        loadPageFor(table, 1);
      } else if (action === 'export') {
        exportCsv(table);
      }
    }

    // Eventos dos filtros globais
    document.getElementById('refresh-btn').addEventListener('click', function(){
      refreshAll(false);
    });
    document.getElementById('date-filter').addEventListener('change', function(){
      refreshAll(true);
    });
    document.getElementById('instance-filter').addEventListener('change', function(){
      refreshAll(true);
    });

    // primeira carga
    refreshAll(true);

    // auto refresh mantendo página atual
    setInterval(function(){
      refreshAll(false);
    }, 30000);

  })();
  </script>
</body>
</html>
