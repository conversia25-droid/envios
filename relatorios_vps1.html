<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relatórios — Produção</title>

  <link rel="stylesheet" href="theme.css"/>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main class="main-content">
    <header class="page-header">
      <h1>Relatórios — Produção</h1>
      <p class="muted">Acompanhe os envios da tabela <strong>disparos_log</strong>.</p>
    </header>

    <section class="card">
      <h2>Leads enviados (recentes)</h2>
      <div class="toolbar">
        <label class="muted" for="date-filter">Data:</label>
        <input type="date" id="date-filter" class="select" style="width:auto;">
        <button id="export-csv" class="btn btn-primary" type="button">Exportar CSV</button>
        <span class="muted" id="leads-hint">Carregando…</span>
      </div>

      <div class="table-wrap" style="margin-top:8px;">
        <table aria-label="Leads enviados">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Instância</th>
              <th>Número</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="leads-tbody">
            <tr><td colspan="4" class="muted">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="summary-grid">
      <div class="summary-item"><div class="label">Total de Envios</div><div class="value" id="total-envios">0</div></div>
      <div class="summary-item"><div class="label">Sucessos</div><div class="value" id="sucesso-total">0</div></div>
      <div class="summary-item"><div class="label">Falhas</div><div class="value" id="falhas-total">0</div></div>
    </section>

    <section class="cards-grid">
      <div class="card"><h2>Envios por Hora</h2><canvas id="chartEnviosHora" height="300"></canvas></div>
      <div class="card"><h2>Envios por Instância</h2><canvas id="chartInstancia" height="300"></canvas></div>
      <div class="card small"><h2>Sucesso x Erro</h2><canvas id="chartStatus" height="200"></canvas></div>
    </section>
  </main>

  <script src="auth.js"></script>
  <script src="layout.js"></script>

  <script>
  // ===== Supabase (sem redeclarar SUPABASE_URL) =====
  const supa = AUTH.getSupabaseInfo();
  const SB_URL = supa.url;
  const HEADERS = AUTH.getSupabaseHeaders();
  const TABLE = "disparos_log";

  const LEAD_FIELD = "numero";
  let SELECTED_DATE = "";
  let LAST_LEADS_ROWS = [];
  let chartHora, chartInstancia, chartStatus;

  const fmtDate = s => s ? new Date(s).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }) : '—';
  const toCsvValue = v => {
    const s = (v ?? "").toString();
    return /[",\n;]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
  };
  const downloadFile = (filename, content, mime="text/csv;charset=utf-8") => {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };

  async function buscarLeads(limit=500) {
    let url = `${SB_URL}/rest/v1/${TABLE}?select=instancia,created_at,status,${LEAD_FIELD}&order=created_at.desc&limit=${limit}`;
    if (SELECTED_DATE) {
      const start = `${SELECTED_DATE}T00:00:00`;
      const end = `${SELECTED_DATE}T23:59:59`;
      url += `&created_at=gte.${start}&created_at=lte.${end}`;
    }
    const res = await fetch(url, { headers: HEADERS });
    if (!res.ok) { console.error("Erro buscarLeads:", res.status, res.statusText); return []; }
    return res.json();
  }

  function renderLeadsTable(rows) {
    const tbody = document.getElementById('leads-tbody');
    const hint  = document.getElementById('leads-hint');
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="4" class="muted">Nenhum registro encontrado.</td></tr>`;
      if (hint) hint.textContent = 'Sem registros.';
      return;
    }
    const html = rows.map(r => {
      const quando = fmtDate(r.created_at);
      const inst   = r.instancia || '—';
      const lead   = r[LEAD_FIELD] || '—';
      const ok     = /ok|enviado/i.test(r.status||'');
      const badge  = ok ? `<span class="badge-ok">${r.status||'OK'}</span>` : `<span class="badge-err">${r.status||'Erro'}</span>`;
      return `<tr><td>${quando}</td><td>${inst}</td><td>${lead}</td><td>${badge}</td></tr>`;
    }).join("");
    tbody.innerHTML = html;
    if (hint) hint.textContent = `Mostrando ${rows.length} registros`;
  }

  function agruparPorHora(rows){
    const out={}; rows.forEach(d=>{ const h=new Date(d.created_at).getHours(); out[h]=(out[h]||0)+1;}); return out;
  }
  function agruparPorInstancia(rows){
    const out={}; rows.forEach(d=>{ const k=d.instancia||'—'; out[k]=(out[k]||0)+1;}); return out;
  }
  function agruparPorStatus(rows){
    const out={Sucesso:0,Erro:0}; rows.forEach(d=>{ (/ok|enviado/i.test(d.status||""))?out.Sucesso++:out.Erro++;}); return out;
  }

  async function atualizarGraficos() {
    const dados = await buscarLeads(1000);
    const porHora = agruparPorHora(dados);
    const porInst = agruparPorInstancia(dados);
    const porStat = agruparPorStatus(dados);

    const ctx1 = document.getElementById('chartEnviosHora').getContext('2d');
    if (!chartHora) {
      chartHora = new Chart(ctx1, { type: 'line',
        data: { labels: Object.keys(porHora), datasets: [{ label:'Envios', data:Object.values(porHora), borderWidth:2, fill:true }] },
        options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    } else {
      chartHora.data.labels = Object.keys(porHora);
      chartHora.data.datasets[0].data = Object.values(porHora);
      chartHora.update();
    }

    const ctx2 = document.getElementById('chartInstancia').getContext('2d');
    if (!chartInstancia) {
      chartInstancia = new Chart(ctx2, { type: 'bar',
        data: { labels: Object.keys(porInst), datasets: [{ label:'Envios por Instância', data:Object.values(porInst), borderWidth:1 }] },
        options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    } else {
      chartInstancia.data.labels = Object.keys(porInst);
      chartInstancia.data.datasets[0].data = Object.values(porInst);
      chartInstancia.update();
    }

    const ctx3 = document.getElementById('chartStatus').getContext('2d');
    if (!chartStatus) {
      chartStatus = new Chart(ctx3, { type: 'doughnut',
        data: { labels: Object.keys(porStat), datasets: [{ data:Object.values(porStat), borderWidth:1 }] },
        options: { responsive:true, plugins:{ legend:{ position:'bottom' } }, cutout:'60%' }
      });
    } else {
      chartStatus.data.labels = Object.keys(porStat);
      chartStatus.data.datasets[0].data = Object.values(porStat);
      chartStatus.update();
    }
  }

  function exportarCsv(){
    const header = ["Data/Hora","Instância","Número","Status"];
    const lines = LAST_LEADS_ROWS.map(r => [fmtDate(r.created_at), r.instancia||"", r[LEAD_FIELD]||"", r.status||""].map(toCsvValue).join(","));
    downloadFile("leads_producao.csv", [header.join(","), ...lines].join("\n"));
  }

  async function init(){
    await atualizarLeads(); await atualizarGraficos();
    document.getElementById('date-filter').addEventListener('change', async (e)=>{ SELECTED_DATE=e.target.value; await atualizarLeads(); await atualizarGraficos(); });
    document.getElementById('export-csv').addEventListener('click', exportarCsv);
    setInterval(async ()=>{ await atualizarLeads(); await atualizarGraficos(); }, 10000);
  }
  async function atualizarLeads(){
    const data = await buscarLeads();
    renderLeadsTable(data);
    document.getElementById('total-envios').textContent = data.length.toLocaleString('pt-BR');
    const sucesso = data.filter(d => /ok|enviado/i.test(d.status||'')).length;
    document.getElementById('sucesso-total').textContent = sucesso.toLocaleString('pt-BR');
    document.getElementById('falhas-total').textContent = (data.length - sucesso).toLocaleString('pt-BR');
  }
  init();
  </script>
</body>
</html>
