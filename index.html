<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>In√≠cio</title>

  <link rel="stylesheet" href="theme.css"/>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .ranking-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .ranking-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .ranking-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ranking-pos {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #0a8f83;
      color: #fff;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    .ranking-count {
      font-weight: 700;
    }

    .rank-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .rank-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
<main class="main-content">

  <header class="page-header">
    <h1>In√≠cio</h1>
  </header>

  <!-- KPIs -->
  <section class="summary-grid">
    <div class="summary-item">
      <div class="label">Disparos Hoje</div>
      <div class="value" id="kpi-dia">0</div>
    </div>
    <div class="summary-item">
      <div class="label">Disparos Semana</div>
      <div class="value" id="kpi-semana">0</div>
    </div>
    <div class="summary-item">
      <div class="label">Disparos M√™s</div>
      <div class="value" id="kpi-mes">0</div>
    </div>
    <div class="summary-item">
      <div class="label">Inst√¢ncias Ativas</div>
      <div class="value" id="instancias-ativas">0</div>
    </div>
  </section>

  <!-- Rankings -->
  <section class="rank-grid">
    <div class="card">
      <h2>Top Inst√¢ncias (Hoje)</h2>
      <div id="rank-dia" class="ranking-list"></div>
    </div>
    <div class="card">
      <h2>Top Inst√¢ncias (Semana)</h2>
      <div id="rank-semana" class="ranking-list"></div>
    </div>
    <div class="card">
      <h2>Top Inst√¢ncias (M√™s)</h2>
      <div id="rank-mes" class="ranking-list"></div>
    </div>
  </section>

  <!-- Gr√°fico -->
  <section class="card" style="margin-top:16px;">
    <h2>Disparos por Per√≠odo</h2>

    <div style="margin-bottom:10px;">
      <button class="btn btn-outline" onclick="setPeriodo('dia')">Di√°rio</button>
      <button class="btn btn-outline" onclick="setPeriodo('semana')">Semanal</button>
      <button class="btn btn-outline" onclick="setPeriodo('mes')">Mensal</button>
    </div>

    <canvas id="chartEnvios"></canvas>
  </section>

</main>

<script src="auth.js"></script>
<script src="layout.js"></script>

<script>
/* =========================================================
   SUPABASE (j√° estava no seu arquivo est√°vel)
   ========================================================= */
const supa = AUTH.getSupabaseInfo();
const SB_URL = supa.url;
const HEADERS = AUTH.getSupabaseHeaders();
const TABLE = AUTH.getDisparosTable();

async function fetchDisparos(limit=10000) {
  const url = `${SB_URL}/rest/v1/${TABLE}?select=instancia,created_at&order=created_at.desc&limit=${limit}`;
  const res = await fetch(url, { headers: HEADERS });
  return res.ok ? res.json() : [];
}
// üëâ 3) COLE A NOVA FUN√á√ÉO AQUI (logo abaixo)
  async function fetchDisparosMesCount() {
    const agora = new Date();

    const inicioMes = new Date(
      agora.getFullYear(),
      agora.getMonth(),
      1, 0, 0, 0, 0
    ).toISOString();

    const fimMes = new Date(
      agora.getFullYear(),
      agora.getMonth() + 1,
      0, 23, 59, 59, 999
    ).toISOString();

    const url =
      `${SB_URL}/rest/v1/${TABLE}` +
      `?created_at=gte.${inicioMes}` +
      `&created_at=lte.${fimMes}` +
      `&select=id`;

    const res = await fetch(url, {
      headers: {
        ...HEADERS,
        Prefer: "count=exact"
      }
    });

    const range = res.headers.get("content-range");
    return range ? Number(range.split("/")[1]) : 0;
  }


/* =========================================================
   ‚úÖ INST√ÇNCIAS ATIVAS (M√çNIMA ALTERA√á√ÉO)
   - Usa o MESMO caminho da p√°gina Inst√¢ncias:
     EVOLUTION_API_URL + "instance/fetchInstances" com header apikey
   - Conta SOMENTE "Conectadas" (connectionStatus === "open")
   ========================================================= */

/** (1) mesma l√≥gica do tenant usada no script.js, mas com nomes pr√≥prios do index */
function __getTenantCfg_Index() {
  const t = (window.AUTH && AUTH.getTenant && AUTH.getTenant()) || {};
  return {
    EVOLUTION_API_URL: String(t.evolutionApiUrl || "https://evoconversia.zapcompany.com.br").replace(/\/+$/,''),
    API_KEY: t.apiKey || ""
  };
}

/** (2) mesma ideia do api() do script.js, mas isolada para n√£o conflitar */
function apiEvo_Index(path, options = {}) {
  const cfg = __getTenantCfg_Index();
  const cleanedPath = String(path).replace(/^\/+/, "");
  const url = `${cfg.EVOLUTION_API_URL}/${cleanedPath}`;
  const headers = {
    apikey: cfg.API_KEY,
    "Content-Type": "application/json",
    ...(options.headers || {})
  };
  return fetch(url, { mode: "cors", ...options, headers });
}

async function fetchInstanciasAtivas() {
  try {
    const res = await apiEvo_Index("instance/fetchInstances", { method: "GET" });
    if (!res.ok) return 0;

    const list = await res.json();
    const arr = Array.isArray(list) ? list : [];

    // IGUAL √Ä P√ÅGINA INST√ÇNCIAS: "Conectadas" = connectionStatus === "open"
    return arr.filter(i =>
      String(i.connectionStatus || "").toLowerCase() === "open"
    ).length;
  } catch (e) {
    console.error("fetchInstanciasAtivas error:", e);
    return 0;
  }
}

/* ========================================================= */

function filtrarPeriodo(data, tipo) {
  const agora = new Date();

  return data.filter(d => {
    const dt = new Date(d.created_at);

    if (tipo === "dia") {
      return dt.toDateString() === agora.toDateString();
    }

    if (tipo === "semana") {
      const inicioSemana = new Date(agora);
      inicioSemana.setHours(0, 0, 0, 0);
      inicioSemana.setDate(agora.getDate() - agora.getDay());

      const fimSemana = new Date(inicioSemana);
      fimSemana.setDate(inicioSemana.getDate() + 6);
      fimSemana.setHours(23, 59, 59, 999);

      return dt >= inicioSemana && dt <= fimSemana;
    }

    if (tipo === "mes") {
  const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1, 0, 0, 0, 0);
  const fimMes = new Date(agora.getFullYear(), agora.getMonth() + 1, 0, 23, 59, 59, 999);

  return dt >= inicioMes && dt <= fimMes;
}
  });
}


function rankingInstancias(data) {
  const m={};
  data.forEach(d=>{
    const i=d.instancia||"‚Äî";
    m[i]=(m[i]||0)+1;
  });
  return Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,5);
}

function renderRanking(id, lista) {
  const el=document.getElementById(id);
  el.innerHTML="";
  lista.forEach(([inst,qtd],idx)=>{
    const div=document.createElement("div");
    div.className="ranking-item";
    div.innerHTML=`
      <div class="ranking-left">
        <div class="ranking-pos">${idx+1}</div>
        <div>${inst}</div>
      </div>
      <div class="ranking-count">${qtd}</div>
    `;
    el.appendChild(div);
  });
}

async function atualizarResumo() {
  const data = await fetchDisparos();

  const dia = filtrarPeriodo(data,"dia");
  const semana = filtrarPeriodo(data,"semana");
  const mes = filtrarPeriodo(data,"mes");

  document.getElementById("kpi-dia").textContent = dia.length;
  document.getElementById("kpi-semana").textContent = semana.length;
  document.getElementById("kpi-mes").textContent =
  await fetchDisparosMesCount();

  // üëá s√≥ essa linha j√° existia, agora a fun√ß√£o funciona de verdade
  document.getElementById("instancias-ativas").textContent = await fetchInstanciasAtivas();

  renderRanking("rank-dia", rankingInstancias(dia));
  renderRanking("rank-semana", rankingInstancias(semana));
  renderRanking("rank-mes", rankingInstancias(mes));
}

let chart, periodoAtual="dia";
function setPeriodo(p){periodoAtual=p;atualizarGrafico();}

async function atualizarGrafico() {
  const data = await fetchDisparos();
  const filtrado = filtrarPeriodo(data, periodoAtual);

  const mapa={};
  filtrado.forEach(d=>{
    const dt=new Date(d.created_at);
    const k = periodoAtual==="dia"
      ? String(dt.getHours()).padStart(2,"0")
      : dt.toLocaleDateString("pt-BR");
    mapa[k]=(mapa[k]||0)+1;
  });

  const ctx=document.getElementById("chartEnvios").getContext("2d");
  if (!chart) {
    chart=new Chart(ctx,{
      type:"line",
      data:{labels:Object.keys(mapa),datasets:[{label:"Disparos",data:Object.values(mapa),fill:true,borderWidth:2}]},
      options:{responsive:true,scales:{y:{beginAtZero:true}}}
    });
  } else {
    chart.data.labels=Object.keys(mapa);
    chart.data.datasets[0].data=Object.values(mapa);
    chart.update();
  }
}

atualizarResumo();
atualizarGrafico();
setInterval(atualizarResumo,10000);
</script>
</body>
</html>
