<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Início | Paiva Dashboard</title>

  <link rel="stylesheet" href="theme.css"/>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

 <style>
    .page-header { margin-bottom: 16px; }
    .page-header h1 { margin: 0 0 6px; font-size: 1.6rem; }
    .muted { color: #6b7280; }
    .grid { display: grid; gap: 14px; }
    @media (min-width: 900px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    .card {
      background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }
    .card h2 { margin: 0 0 8px; font-size: 1.1rem; }
    .btn { cursor: pointer; border: none; border-radius: 10px; padding: 10px 12px; font-weight: 700; }
    .btn-primary { background: #0a8f83; color: #fff; }
    .btn-outline { background: #fff; color: #111; border: 1px solid #e5e7eb; }
    .form-group { display: grid; gap: 6px; margin-bottom: 10px; }
    textarea, input[type="number"], input[type="text"], input[type="url"], input[type="file"] {
      width: 100%; padding: 10px 12px; border: 1px solid #0b1b3a; border-radius: 10px;
      background: #fff; box-sizing: border-box; font-family: inherit; font-size: 1rem;
    }
    .form-check { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .form-check input { transform: translateY(1px); }
    .status-box { display: none; margin-top: 10px; padding: 10px 12px; border: 1px dashed #d1d5db; border-radius: 10px; background: #f9fafb; }
    .img-preview { display:flex; gap:10px; align-items:center; }
    .img-preview img { max-width: 240px; border-radius: 10px; border:1px solid #e5e7eb; }
    .send-type { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .send-type label { display:flex; gap:6px; align-items:center; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <main class="main-content">
    <header class="page-header">
      <h1>Painel Geral</h1>
      <p>Resumo do sistema e indicadores em tempo real.</p>
    </header>

    <!-- ===================== RESUMO ===================== -->
    <section class="summary-grid">
      <div class="summary-item">
        <div class="label">Total de Disparos</div>
        <div class="value" id="total-envios">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Disparos Hoje</div>
        <div class="value" id="envios-hoje">0</div>
      </div>
      <div class="summary-item">
        <div class="label">Instâncias Ativas</div>
        <div class="value" id="instancias-ativas">0</div>
      </div>
    </section>

    <!-- ===================== GRÁFICO DE ENVIOS ===================== -->
    <section class="cards-grid">
      <div class="card">
        <h2>Gráfico de Disparos por Hora</h2>
        <div style="height:340px;">
          <canvas id="chartEnvios"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>Disparos por Instância</h2>
        <div style="height:340px;">
          <canvas id="chartInstancias"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- ========== SCRIPTS ========== -->
  <script src="auth.js"></script>
  <script src="layout.js"></script>

  <script>
  // ============================================
  // SUPABASE via AUTH + tabela dinâmica por tenant
  // ============================================
  const { url: SB_URL } = AUTH.getSupabaseInfo();
  const SB_HEADERS = AUTH.getSupabaseHeaders();
  const TABLE = AUTH.getDisparosTable(); // disparos_log | disparos_log_local | disparos_log_vps1

  async function fetchDisparos(limit = 2000) {
    const url = `${SB_URL}/rest/v1/${TABLE}?select=instancia,created_at,status&order=created_at.asc&limit=${limit}`;
    const res = await fetch(url, { headers: SB_HEADERS });
    return res.ok ? res.json() : [];
  }

  // ============================================
  // ATUALIZA OS INDICADORES
  // ============================================
  async function atualizarIndicadores() {
    const data = await fetchDisparos();
    const total = data.length;

    const hoje = new Date().toISOString().split('T')[0];
    const enviadosHoje = data.filter(d => (d.created_at || '').startsWith(hoje)).length;

    const instancias = new Set(data.map(d => d.instancia));
    document.getElementById('total-envios').textContent = total.toLocaleString('pt-BR');
    document.getElementById('envios-hoje').textContent = enviadosHoje.toLocaleString('pt-BR');
    document.getElementById('instancias-ativas').textContent = instancias.size;
  }

  // ============================================
  // GRÁFICO DE ENVIOS POR HORA / POR INSTÂNCIA
  // ============================================
  let chartEnvios, chartInstancias;

  async function atualizarGraficos() {
    const data = await fetchDisparos();
    if (!data.length) return;

    // --- Agrupa por hora ---
    const porHora = {};
    data.forEach(d => {
      const hora = new Date(d.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit' });
      porHora[hora] = (porHora[hora] || 0) + 1;
    });

    // --- Agrupa por instância ---
    const porInstancia = {};
    data.forEach(d => {
      const key = d.instancia || '—';
      porInstancia[key] = (porInstancia[key] || 0) + 1;
    });

    // --- Gráfico 1 (linha) ---
    const ctx1 = document.getElementById('chartEnvios').getContext('2d');
    if (!chartEnvios) {
      chartEnvios = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: Object.keys(porHora),
          datasets: [{
            label: 'Mensagens Enviadas',
            data: Object.values(porHora),
            borderWidth: 2,
            fill: true
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    } else {
      chartEnvios.data.labels = Object.keys(porHora);
      chartEnvios.data.datasets[0].data = Object.values(porHora);
      chartEnvios.update();
    }

    // --- Gráfico 2 (barras) ---
    const ctx2 = document.getElementById('chartInstancias').getContext('2d');
    if (!chartInstancias) {
      chartInstancias = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: Object.keys(porInstancia),
          datasets: [{
            label: 'Envios por Instância',
            data: Object.values(porInstancia),
            borderWidth: 1
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    } else {
      chartInstancias.data.labels = Object.keys(porInstancia);
      chartInstancias.data.datasets[0].data = Object.values(porInstancia);
      chartInstancias.update();
    }
  }

  // Atualiza tudo a cada 10 segundos
  setInterval(() => {
    atualizarIndicadores();
    atualizarGraficos();
  }, 10000);

  atualizarIndicadores();
  atualizarGraficos();
  </script>
</body>
</html>
