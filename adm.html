<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Relat√≥rios ‚Äî Admin (paginado)</title>

  <link rel="stylesheet" href="theme.css"/>
  <link rel="stylesheet" href="style.css"/>

  <style>
    body {
      background: var(--bg,#f9fafb);
      color: var(--fg,#111);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .muted { color:#6b7280; font-size:.9rem; }

    .page-header h1 {
      margin:0 0 4px;
      font-size:1.15rem;
      font-weight:600;
    }
    .page-header p { margin:0; }

    .toolbar {
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .select {
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:.9rem;
      background:#fff;
    }
    .btn {
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      background:#fff;
      font-size:.9rem;
      cursor:pointer;
      white-space:nowrap;
      flex-shrink:0;
    }
    .btn:disabled { opacity:.4; cursor:not-allowed; }
    .btn-primary {
      background:#0a8f83;
      border:none;
      color:#fff;
      font-weight:600;
    }

    .filters-card {
      background:#fff;
      border-radius:12px;
      box-shadow:0 1px 4px rgb(0 0 0 / .06);
      padding:12px;
      margin-bottom:16px;
    }

    .relatorios-wrapper {
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:flex-start;
    }

    .relatorio-card {
      flex:1 1 320px;
      min-width:300px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 1px 4px rgb(0 0 0 / .06);
      padding:12px;

      /* garante consist√™ncia de layout em todas as colunas */
      display:flex;
      flex-direction:column;
      max-width:100%;
    }

    /* header do card (t√≠tulo + hint) */
    .relatorio-card h3 {
      margin:0 0 8px;
      font-size:1rem;
      font-weight:600;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      line-height:1.2;
      flex-wrap:nowrap;
      white-space:nowrap;
    }

    /* nome do card (ex: VPS1) fica do lado esquerdo e pode cortar com retic√™ncias */
    .relatorio-card h3 span:first-child {
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:60%;
      display:inline-block;
    }

    /* subt√≠tulo cinza (ex: disparos_log_vps1) fica compacto √† direita */
    .relatorio-card h3 .card-hint {
      font-size:.7rem;
      color:#6b7280;
      font-weight:400;
      white-space:nowrap;
      flex-shrink:0;
    }

    /* barra com pagina√ß√£o/bot√µes */
    .controls {
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      row-gap:8px;
      column-gap:8px;
      margin-bottom:8px;
    }

    .controls .page-indicator {
      font-weight:600;
      font-size:.9rem;
      white-space:nowrap;
    }

    .table-scroll {
      max-height:520px;
      overflow:auto;
      border-top:1px solid #eee;
      border-radius:8px;
      background:#fff;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:.85rem;
      min-width:100%;
      table-layout:fixed; /* garante colunas com larguras est√°veis */
    }

    thead th {
      text-align:left;
      padding:8px;
      background:#fbfbfb;
      position:sticky;
      top:0;
      z-index:1;
      font-weight:600;
      border-bottom:1px solid #e5e7eb;
      white-space:nowrap;
    }

    tbody td {
      padding:8px;
      border-top:1px solid #f3f3f3;
      vertical-align:top;
      line-height:1.3;
      word-break:break-word;
    }

    /* fixa largura das colunas pra n√£o quebrar layout no 3¬∫ card */
    .table-scroll th:nth-child(1),
    .table-scroll td:nth-child(1) {
      width:32%;
      word-break:break-word;
    }
    .table-scroll th:nth-child(2),
    .table-scroll td:nth-child(2) {
      width:14%;
      text-align:left;
      word-break:break-word;
    }
    .table-scroll th:nth-child(3),
    .table-scroll td:nth-child(3) {
      width:34%;
      word-break:break-all; /* n√∫mero pode ser grande */
    }
    .table-scroll th:nth-child(4),
    .table-scroll td:nth-child(4) {
      width:20%;
      text-align:center;
    }

    .badge-ok {
      background:#10b981;
      color:#fff;
      padding:4px 8px;
      border-radius:999px;
      font-weight:600;
      font-size:.75rem;
      display:inline-block;
      line-height:1.2;
      white-space:nowrap;
    }
    .badge-err {
      background:#ef4444;
      color:#fff;
      padding:4px 8px;
      border-radius:999px;
      font-weight:600;
      font-size:.75rem;
      display:inline-block;
      line-height:1.2;
      white-space:nowrap;
    }
  </style>
</head>
<body>
  <main class="main-content" style="padding:16px; max-width:1600px; margin:0 auto;">
    <header class="page-header" style="margin-bottom:12px;">
      <h1>Relat√≥rios ‚Äî Admin (paginado)</h1>
      <p class="muted">
        Vis√£o unificada (Produ√ß√£o / Local / VPS1). Listas lado a lado. 500 registros por p√°gina. Status ‚Äúenviado‚Äù em verde.
      </p>
    </header>

    <!-- prote√ß√£o admin -->
    <script src="auth.js"></script>
    <script>
      const __tenant = AUTH.getTenant();
      if (!__tenant || __tenant.id !== "admin") {
        alert("Acesso restrito ao administrador.");
        location.href = "login.html";
      }
    </script>

    <section id="filters" class="filters-card">
      <div class="toolbar">
        <label class="muted">Data:</label>
        <input type="date" id="date-filter" class="select" value="" />

        <label class="muted">Inst√¢ncia:</label>
        <select id="instance-filter" class="select">
          <option value="">Todas</option>
        </select>

        <button id="refresh-btn" class="btn">Atualizar</button>

        <span class="muted" id="leads-hint">Carregando‚Ä¶</span>
      </div>
    </section>

    <section class="relatorios-wrapper" id="relatorios-wrapper">
      <!-- cards gerados dinamicamente -->
    </section>
  
<section class="card">
  <h3 style="margin-top:0">EvolutionAPI (Admin)</h3>
  <p class="muted">Defina aqui a URL e a API Key que ir√£o sobrescrever, somente para o <b>tenant</b> logado, a configura√ß√£o padr√£o do auth.js.</p>
  <div class="form-row">
    <div>
      <label class="muted">EvolutionAPI URL</label>
      <input type="text" id="adm-evo-url" placeholder="https://maturaevo.zapcompany.com.br">
    </div>
    <div>
      <label class="muted">API Key</label>
      <input type="text" id="adm-evo-key" placeholder="cole sua API Key">
    </div>
  </div>
  <div class="form-row" style="margin-top:8px;">
    <button class="btn btn-primary" id="adm-save-evo">Salvar</button>
    <button class="btn btn-outline" id="adm-clear-evo">Limpar</button>
    <span class="muted" id="adm-evo-msg"></span>
  </div>
</section>

<section class="card">
  <h3 style="margin-top:0">Conectar N√∫mero (Admin)</h3>
  <p class="muted">Crie/pareie uma inst√¢ncia e leia o QR Code neste painel.</p>

  <div class="form-row">
    <div>
      <label class="muted">Nome da inst√¢ncia</label>
      <input type="text" id="adm-inst-name" placeholder="ex.: chip01, suporte02">
    </div>
    <div style="display:flex; gap:8px; align-items:flex-end;">
      <button class="btn btn-primary" id="adm-inst-create">Criar</button>
      <button class="btn" id="adm-inst-start">Iniciar</button>
      <button class="btn btn-outline" id="adm-inst-stop">Parar</button>
      <button class="btn btn-outline" id="adm-inst-del">Excluir</button>
    </div>
  </div>

  <div class="form-row" style="margin-top:8px;">
    <button class="btn" id="adm-show-qr">Mostrar QR</button>
    <span class="muted" id="adm-inst-state">‚Äî</span>
  </div>

  <div id="adm-qr-wrap" style="display:none; margin-top:10px;">
    <div class="muted">Leia o QR no WhatsApp do aparelho.</div>
    <img id="adm-qr-img" alt="QR Code" style="max-width:280px; border-radius:10px; border:1px solid rgba(0,0,0,.08);" />
  </div>
</section>

<script>
(function adminEnhancer(){
  if(!window.AUTH || !AUTH.isLoggedIn || !AUTH.isLoggedIn()){ return; }
  const u = AUTH.getUser && AUTH.getUser();
  const isAdmin = u && (u.role === 'admin' || /admin|root/i.test(u.email||''));
  // Mesmo que n√£o haja role formal, vamos permitir aqui para o admin do painel
  // (ajuste conforme seu controle de permiss√µes)
  try {
    // Preencher campos com overrides atuais
    const cur = (window.getEvolutionOverride && getEvolutionOverride()) || {url:'', key:''};
    const urlEl = document.getElementById('adm-evo-url');
    const keyEl = document.getElementById('adm-evo-key');
    if(urlEl) urlEl.value = cur.url || 'https://maturaevo.zapcompany.com.br';
    if(keyEl) keyEl.value = cur.key || '429683C4C977415CAAFCCE10F7D57E11';

    const msg = document.getElementById('adm-evo-msg');
    const save = document.getElementById('adm-save-evo');
    const clear= document.getElementById('adm-clear-evo');
    if(save) save.onclick = () => {
      const ok = window.setEvolutionOverride && setEvolutionOverride(urlEl.value.trim(), keyEl.value.trim());
      if(msg) msg.textContent = ok ? 'Salvo!' : 'Falhou ao salvar';
      setTimeout(()=>{ if(msg) msg.textContent=''; }, 1200);
    };
    if(clear) clear.onclick = () => {
      const t = (window.AUTH && AUTH.getTenant && AUTH.getTenant()) || { id:'prod' };
      const id = t.id || 'prod';
      localStorage.removeItem('EVO_URL_OVERRIDE__'+id);
      localStorage.removeItem('EVO_KEY_OVERRIDE__'+id);
      if(msg) msg.textContent = 'Limpado!';
      setTimeout(()=>{ if(msg) msg.textContent=''; }, 1200);
    };

    // Conectar inst√¢ncia com QR
    const nameEl = document.getElementById('adm-inst-name');
    const stateEl= document.getElementById('adm-inst-state');
    const qrWrap = document.getElementById('adm-qr-wrap');
    const qrImg  = document.getElementById('adm-qr-img');

    async function _api(p, opts){ return await api(p, opts); }

    async function checkState(inst){
      try{
        const r = await _api('instance/connectionState/'+encodeURIComponent(inst), { method:'GET' });
        const s = r.ok ? (await r.text()) : ('HTTP '+r.status);
        if(stateEl) stateEl.textContent = 'Estado: '+ (s || 'desconhecido');
      }catch(e){ if(stateEl) stateEl.textContent = 'Estado: erro: '+e.message; }
    }

    async function showQR(inst){
      try {
        if(qrWrap) qrWrap.style.display = 'block';
        if(stateEl) stateEl.textContent = 'Gerando QR...';
        const tryPaths = [
          'instance/qrcode/'+encodeURIComponent(inst)+'?format=base64',
          'instance/qr/'+encodeURIComponent(inst)+'?format=base64',
          'instance/qr/'+encodeURIComponent(inst)
        ];
        for(const p of tryPaths){
          const res = await _api(p, { method:'GET' });
          if(res.ok){
            const t = await res.text();
            if(/^data:image\/png;base64,/.test(t) || /^data:/.test(t)){
              if(qrImg) qrImg.src = t;
              if(stateEl) stateEl.textContent = 'Aguardando leitura...';
              return;
            }else{
              // pode vir somente o base64 puro
              if(qrImg) qrImg.src = 'data:image/png;base64,'+t;
              if(stateEl) stateEl.textContent = 'Aguardando leitura...';
              return;
            }
          }
        }
        if(stateEl) stateEl.textContent = 'N√£o foi poss√≠vel obter o QR.';
      }catch(e){
        if(stateEl) stateEl.textContent = 'Erro ao obter QR: '+e.message;
      }
    }

    function instName(){ return (nameEl && nameEl.value.trim()) || ''; }

    const btnCreate = document.getElementById('adm-inst-create');
    const btnStart  = document.getElementById('adm-inst-start');
    const btnStop   = document.getElementById('adm-inst-stop');
    const btnDel    = document.getElementById('adm-inst-del');
    const btnQR     = document.getElementById('adm-show-qr');

    if(btnCreate) btnCreate.onclick = async () => {
      const nn = instName(); if(!nn) return alert('Informe o nome da inst√¢ncia.');
      const r = await _api('instance/create', { method:'POST', body: JSON.stringify({ instanceName: nn }) });
      const t = await r.text();
      alert(r.ok ? 'Criada: '+t : ('Falha: '+t));
    };
    if(btnStart) btnStart.onclick = async () => {
      const nn = instName(); if(!nn) return alert('Informe o nome da inst√¢ncia.');
      const r = await _api('instance/start/'+encodeURIComponent(nn), { method:'POST' });
      const t = await r.text();
      alert(r.ok ? 'Iniciada: '+t : ('Falha: '+t));
    };
    if(btnStop) btnStop.onclick = async () => {
      const nn = instName(); if(!nn) return alert('Informe o nome da inst√¢ncia.');
      const r = await _api('instance/stop/'+encodeURIComponent(nn), { method:'POST' });
      const t = await r.text();
      alert(r.ok ? 'Parada: '+t : ('Falha: '+t));
    };
    if(btnDel) btnDel.onclick = async () => {
      const nn = instName(); if(!nn) return alert('Informe o nome da inst√¢ncia.');
      const r = await _api('instance/delete/'+encodeURIComponent(nn), { method:'DELETE' });
      const t = await r.text();
      alert(r.ok ? 'Exclu√≠da: '+t : ('Falha: '+t));
    };
    if(btnQR) btnQR.onclick = async () => {
      const nn = instName(); if(!nn) return alert('Informe o nome da inst√¢ncia.');
      await showQR(nn);
      // Come√ßa a checar estado a cada 5s
      setInterval(()=>checkState(nn), 5000);
    };
  } catch(e){ console.warn('Admin enhancer falhou', e); }
})();
</script>


<section class="card">
  <h3 style="margin-top:0;">Selecionar Servidor Evolution</h3>
  <p class="muted">Escolha qual servidor o painel deve usar agora (apenas administradores).</p>
  <select id="evo-selector"></select>
  <button class="btn" id="evo-apply" style="margin-top:8px;">Aplicar</button>
  <span id="evo-apply-msg" class="muted"></span>
</section>
<script>
document.addEventListener("DOMContentLoaded", () => {
  try {
    const t = (AUTH && AUTH.getTenant && AUTH.getTenant()) || { id:"prod" };
    const sel = document.getElementById("evo-selector");
    const apply = document.getElementById("evo-apply");
    const msg = document.getElementById("evo-apply-msg");
    const extras = (t && t.evolutionsExtras) || [];
    const opts = [
      { label: "üåê Servidor Principal", evolutionApiUrl: t.evolutionApiUrl || t.EVOLUTION_API_URL, apiKey: t.apiKey || t.API_KEY },
      ...extras
    ].filter(o => o && o.evolutionApiUrl);
    sel.innerHTML = opts.map(o => `<option value="${o.evolutionApiUrl}|${o.apiKey||''}">${o.label}</option>`).join("");
    const curUrl = localStorage.getItem("EVO_URL_OVERRIDE__"+t.id) || (t.evolutionApiUrl || t.EVOLUTION_API_URL) || "";
    const curKey = localStorage.getItem("EVO_KEY_OVERRIDE__"+t.id) || (t.apiKey || t.API_KEY) || "";
    const curVal = curUrl + "|" + curKey;
    for (const opt of sel.options){ if (opt.value === curVal) { sel.value = curVal; break; } }
    apply.onclick = () => {
      const [url, key] = sel.value.split("|");
      localStorage.setItem("EVO_URL_OVERRIDE__"+t.id, String(url||""));
      localStorage.setItem("EVO_KEY_OVERRIDE__"+t.id, String(key||""));
      msg.textContent = "Aplicado! Atualize a p√°gina.";
      setTimeout(()=>msg.textContent="",1500);
    };
  } catch(e){}
});
</script>

</main>

  <script src="layout.js"></script>
  <script>
  (function(){

    // 1. Configura√ß√£o Supabase (puxado do auth.js que voc√™ j√° tem)
    const supa = AUTH.getSupabaseInfo();
    const SB_URL = supa.url;
    const BASE_HEADERS = {
      "Content-Type": "application/json",
      "Accept": "application/json",
      "apikey": supa.key,
      "Authorization": "Bearer " + supa.key,
      "Prefer": "return=representation,count=exact",
      "Range-Unit": "items"
    };

    // 2. Tabelas monitoradas
    const TABLES = [
      { key: 'disparos_log_vps1',     name: 'VPS1    ' },
      { key: 'disparos_log_local',    name: 'Local'    },
      { key: 'disparos_log',          name: 'Produ√ß√£o' }
    ];

    const LEAD_FIELD = 'numero';
    const PAGE_SIZE = 500;

    // 3. Estado de pagina√ß√£o por tabela
    const state = {};
    TABLES.forEach(t => {
      state[t.key] = {
        page: 0,
        rows: [],
        hasMore: true,
        loading: false
      };
    });

    // ===== Helpers =====

    // Formata data/hora do banco pro padr√£o BR
    function fmtDate(dtStr) {
      if (!dtStr) return '‚Äî';
      const d = new Date(dtStr);
      if (isNaN(d)) return dtStr;
      return d.toLocaleString('pt-BR', {
        dateStyle: 'short',
        timeStyle: 'short'
      });
    }

    // Cria badge verde/vermelha pro status
    function badgeStatus(st) {
      const ok = /ok|enviado/i.test(st || '');
      return ok
        ? '<span class="badge-ok">' + (st || 'OK') + '</span>'
        : '<span class="badge-err">' + (st || 'Erro') + '</span>';
    }

    // Monta o HTML interno de cada card (cada tabela)
    function buildCardHtml(tableKey, title) {
      return `
        <div class="relatorio-card" id="card-${tableKey}">
          <h3>
            <span>${title}</span>
            <span class="card-hint">${tableKey}</span>
          </h3>

          <div class="controls">
            <button class="btn" data-action="prev" data-table="${tableKey}">Anterior</button>
            <button class="btn" data-action="next" data-table="${tableKey}">Pr√≥xima</button>

            <div class="page-indicator" id="page-${tableKey}">P√°gina 1</div>

            <div style="flex:1"></div>

            <button class="btn btn-primary" data-action="export" data-table="${tableKey}">
              Exportar CSV
            </button>
          </div>

          <div class="table-scroll">
            <table aria-label="${title}">
              <thead>
                <tr>
                  <th>Data/Hora</th>
                  <th>Inst√¢ncia</th>
                  <th>N√∫mero</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tbody-${tableKey}">
                <tr><td colspan="4" class="muted">Carregando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // Renderiza os 3 cards s√≥ uma vez
    function renderCardsOnce() {
      const wrap = document.getElementById('relatorios-wrapper');
      if (!wrap) return;
      if (wrap.dataset.built === "1") return;

      wrap.innerHTML = TABLES.map(t => buildCardHtml(t.key, t.name)).join('');
      wrap.dataset.built = "1";

      // adiciona listeners dos bot√µes
      wrap.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', onCardButton);
      });
    }

    // ===== Filtro de data como intervalo (gte / lt) =====
    // Ex.: se voc√™ escolhe 2025-10-28, buscamos:
    // created_at >= 2025-10-28T00:00:00
    // created_at <  2025-10-29T00:00:00
    function buildDateFilterParts(dateStr) {
      if (!dateStr) return {gte: null, lt: null};

      const [y, m, d] = dateStr.split("-").map(Number);

      // in√≠cio do dia selecionado
      const start = `${dateStr}T00:00:00`;

      // dia seguinte (UTC) pra fazer o "lt"
      const base = new Date(Date.UTC(y, m-1, d, 0, 0, 0));
      const next = new Date(base.getTime() + 24*60*60*1000);

      const yyyy = next.getUTCFullYear();
      const mm   = String(next.getUTCMonth()+1).padStart(2,"0");
      const dd   = String(next.getUTCDate()).padStart(2,"0");
      const endExclusive = `${yyyy}-${mm}-${dd}T00:00:00`;

      return { gte: start, lt: endExclusive };
    }

    // ===== Busca paginada no Supabase =====
    async function fetchPage(tableKey, page, limit = PAGE_SIZE) {
      const start = page * limit;
      const end   = start + limit - 1;

      const dateFilter = document.getElementById('date-filter').value || "";
      const instanceFilter = document.getElementById('instance-filter').value || "";

      let url = SB_URL + '/rest/v1/' + tableKey +
        '?select=instancia,created_at,status,' + LEAD_FIELD +
        '&order=created_at.desc';

      // aplica intervalo de data se houver filtro
      if (dateFilter.trim() !== "") {
        const range = buildDateFilterParts(dateFilter.trim());
        if (range.gte) {
          url += '&created_at=gte.' + encodeURIComponent(range.gte);
        }
        if (range.lt) {
          url += '&created_at=lt.' + encodeURIComponent(range.lt);
        }
      }

      // aplica filtro de inst√¢ncia se houver
      if (instanceFilter.trim() !== "") {
        url += '&instancia=eq.' + encodeURIComponent(instanceFilter.trim());
      }

      // pagina√ß√£o via header Range
      const headers = {
        ...BASE_HEADERS,
        "Range": start + "-" + end
      };

      try {
        const res = await fetch(url, { headers });
        if (!res.ok) {
          console.error('fetchPage erro', tableKey, res.status, await res.text());
          return [];
        }
        const data = await res.json();
        return data;
      } catch (err) {
        console.error('fetchPage catch', tableKey, err);
        return [];
      }
    }

    // Carrega p√°gina atual (ou vai pra pr√≥xima/anterior)
    async function loadPageFor(tableKey, direction = 0) {
      const s = state[tableKey];
      if (s.loading) return;
      s.loading = true;

      if (direction === 1) {
        s.page++;
      } else if (direction === -1) {
        s.page = Math.max(0, s.page - 1);
      }

      const rows = await fetchPage(tableKey, s.page);
      s.rows = rows;
      s.hasMore = (rows.length === PAGE_SIZE);
      s.loading = false;

      updateCardUI(tableKey);
    }

    // Atualiza o HTML da tabela, pagina√ß√£o e bot√µes
    function updateCardUI(tableKey) {
      const s = state[tableKey];
      const tbody = document.getElementById('tbody-' + tableKey);
      const pageEl = document.getElementById('page-' + tableKey);
      const card = document.getElementById('card-' + tableKey);

      if (!tbody || !pageEl || !card) return;

      if (!s.rows || !s.rows.length) {
        tbody.innerHTML = `
          <tr><td colspan="4" class="muted">Nenhum registro nesta p√°gina.</td></tr>
        `;
      } else {
        tbody.innerHTML = s.rows.map(r => `
          <tr>
            <td>${fmtDate(r.created_at)}</td>
            <td>${r.instancia || '‚Äî'}</td>
            <td>${r[LEAD_FIELD] || '‚Äî'}</td>
            <td>${badgeStatus(r.status)}</td>
          </tr>
        `).join('');
      }

      pageEl.textContent = 'P√°gina ' + (s.page + 1);

      const prevBtn = card.querySelector('button[data-action="prev"]');
      const nextBtn = card.querySelector('button[data-action="next"]');
      if (prevBtn) prevBtn.disabled = (s.page === 0);
      if (nextBtn) nextBtn.disabled = !s.hasMore;
    }

    // Exporta CSV s√≥ da p√°gina atual
    function exportCsv(tableKey) {
      const s = state[tableKey];
      const header = ['Data/Hora','Inst√¢ncia','N√∫mero','Status'];
      const lines = (s.rows || []).map(r => {
        const cols = [
          fmtDate(r.created_at),
          r.instancia || '',
          r[LEAD_FIELD] || '',
          r.status || ''
        ];
        return cols.map(v => {
          const text = (v || '').toString();
          return /[",\n;]/.test(text)
            ? '"' + text.replace(/"/g, '""') + '"'
            : text;
        }).join(',');
      });

      const csv = [header.join(','), ...lines].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url;
      a.download = 'leads_' + tableKey + '_page' + (state[tableKey].page+1) + '.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Monta o dropdown de inst√¢ncias dispon√≠veis
    async function populateInstances() {
      const headers = {
        ...BASE_HEADERS,
        "Range": "0-199"
      };

      let allRows = [];
      for (const t of TABLES) {
        const url = SB_URL + '/rest/v1/' + t.key +
          '?select=instancia&order=created_at.desc';
        try {
          const res = await fetch(url, { headers });
          if (res.ok) {
            const data = await res.json();
            allRows = allRows.concat(data);
          }
        } catch(e) {
          console.error("populateInstances catch", e);
        }
      }

      const instSet = new Set();
      allRows.forEach(r => { if (r.instancia) instSet.add(r.instancia); });

      const combo = document.getElementById('instance-filter');
      const currentVal = combo.value;
      combo.innerHTML = '<option value="">Todas</option>';
      Array.from(instSet).sort().forEach(inst => {
        const opt = document.createElement('option');
        opt.value = inst;
        opt.textContent = inst;
        combo.appendChild(opt);
      });
      if ([...instSet].includes(currentVal)) combo.value = currentVal;
    }

    // Atualiza tudo: dados tabela + inst√¢ncias + timestamp "Atualizado: ..."
    async function refreshAll(resetPage=true) {
      renderCardsOnce();

      if (resetPage) {
        TABLES.forEach(t => { state[t.key].page = 0; });
      }

      // recarrega cada tabela respeitando filtros atuais
      for (const t of TABLES) {
        await loadPageFor(t.key, 0);
      }

      // atualiza o select de inst√¢ncia
      await populateInstances();

      document.getElementById('leads-hint').textContent =
        'Atualizado: ' + new Date().toLocaleString('pt-BR');
    }

    // Listener dos bot√µes dentro de cada card
    function onCardButton(e) {
      const btn = e.currentTarget;
      const table = btn.getAttribute('data-table');
      const action = btn.getAttribute('data-action');
      if (action === 'prev') {
        loadPageFor(table, -1);
      } else if (action === 'next') {
        loadPageFor(table, 1);
      } else if (action === 'export') {
        exportCsv(table);
      }
    }

    // Eventos dos filtros globais
    document.getElementById('refresh-btn').addEventListener('click', function(){
      refreshAll(false);
    });
    document.getElementById('date-filter').addEventListener('change', function(){
      refreshAll(true);
    });
    document.getElementById('instance-filter').addEventListener('change', function(){
      refreshAll(true);
    });

    // primeira carga
    refreshAll(true);

    // auto refresh mantendo p√°gina atual
    setInterval(function(){
      refreshAll(false);
    }, 30000);

  })();
  </script>
</body>
</html>
